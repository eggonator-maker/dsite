<?php

/**
 * @file
 * Hooks for the price_importer module.
 */

declare(strict_types=1);

use Drupal\price_importer\Service\PriceImporterService;

/**
 * Implements hook_preprocess_block().
 *
 * Injects the prices_data variable (decoded from JSON state) into the
 * prices_block template, bypassing the paragraph entity loading entirely.
 */
function price_importer_preprocess_block(array &$variables): void {
  $content = $variables['elements']['content'] ?? [];
  if (empty($content['#block_content'])) {
    return;
  }

  /** @var \Drupal\block_content\Entity\BlockContent $block_content */
  $block_content = $content['#block_content'];
  if ($block_content->bundle() !== PriceImporterService::PRICES_BLOCK_BUNDLE) {
    return;
  }

  $json = \Drupal::state()->get(PriceImporterService::STATE_KEY, '');
  if ($json !== '') {
    $variables['prices_data'] = json_decode($json, TRUE);
  }
}
